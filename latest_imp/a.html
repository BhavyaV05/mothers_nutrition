{% extends "base.html" %}
{% block content %}

<style>
    /* All your CSS styles */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7fa;
        color: #333;
        line-height: 1.6;
    }
    .card {
        background-color: #ffffff;
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 24px;
        margin-bottom: 24px;
    }
    h2, h3 {
        color: #007bff;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
        margin-top: 0;
        margin-bottom: 16px;
    }
    label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-weight: 600;
        color: #555;
    }
    input:not([type="file"]), select, button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
    }
    button {
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        font-weight: bold;
    }
    button:hover { background-color: #0056b3; }
    #refreshHistory {
        background-color: #6c757d;
        margin-bottom: 16px;
    }
    #refreshHistory:hover { background-color: #5a6268; }
    
    /* NEW Recommendation Box Style */
    .recommendation-box {
        background: #f4f8ff; 
        border: 1px solid #c9dbff; 
        border-radius: 12px; 
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .recommendation-box h3 {
        color: #0056b3; /* Darker blue */
        border: none; /* No line */
    }
    .recommendation-box a {
        font-weight: bold;
        color: #007bff;
    }

    #resultArea, #mealHistory {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    .meal-item {
        border-bottom: 1px solid #e9ecef;
        padding: 12px 0;
    }
    .meal-item:last-child { border-bottom: none; }
    .meal-item strong { color: #007bff; font-size: 1.1em; }
    pre {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
    }
    /* ... (keep your floating button and modal styles) ... */
    .floating-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        border: none;
        font-size: 24px;
        z-index: 9999;
        cursor: pointer;
    }
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; }
    .close-modal { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; }
    /* ... (keep query history styles) ... */
    .query-history-item { background: #f8f9fa; border-left: 4px solid #007bff; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
    .query-answer { background: #e6f7ff; border-left: 4px solid #28a745; padding: 10px; margin-top: 8px; border-radius: 4px; }
    #queryModal textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
</style>

<h2>Your Daily Recommendation</h2>

<div id="recommendation-area">
    {% if latest_recommendation %}
        <div class="recommendation-box">
            <p><strong>{{ latest_recommendation.reason }}</strong></p>
            <h3>For your next meal, try: {{ latest_recommendation['Dish Name'] }}</h3>
            <p>
                We found a recipe for you:
                <a href="{{ latest_recommendation['recipe_link'] }}" target="_blank">
                    View Recipe
                </a>
            </p>
        </div>
    {% else %}
        <p>You're doing great! No specific recommendations right now. Keep logging your meals!</p>
    {% endif %}
</div>

---

<div class="card" style="background-color: #e9f5ff;">
    <h3>Assigned Doctor</h3>
    <div id="doctorDetails"><em>Checking assignment...</em></div>
</div>
<input type="hidden" id="assignedDoctorId" value="{{ assigned_doctor_id }}" />

---

<div class="card">
    <h2>Upload Meal Photo</h2>
    <p>Upload your meal photo, select the meal type and date. The system will analyze your meal and update your recommendation.</p>

    <form id="uploadForm">
        <input type="hidden" id="motherId" name="motherId" value="{{ mother_id }}" />
        <label for="mealType">Meal Type</label>
        <select id="mealType" name="mealType" required>
            <option value="">-- Select Meal --</option>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
        </select>
        <label for="mealDate">Meal Date</label>
        <input id="mealDate" name="mealDate" type="date" required />
        <label for="image">Meal Image</label>
        <input id="image" name="image" type="file" accept="image/*" required style="padding: 6px;"/> 
        <button type="submit" style="margin-top:16px;">üì∏ Upload & Analyze Meal</button>
    </form>
</div>

---

<div class="card">
    <h3>Upload Result</h3>
    <div id="resultArea"><em>No upload yet.</em></div>
</div>

---

<div class="card">
    <h3>Your Meal History</h3>
    <button id="refreshHistory">üîÑ Refresh History</button>
    <div id="mealHistory"><em>Loading...</em></div>
</div>


<script>
function getMotherId() {
    return document.getElementById("motherId").value.trim();
}

// --- Load Doctor Details ---
async function loadDoctorDetails() {
    const doctorId = document.getElementById("assignedDoctorId").value.trim();
    const detailsDiv = document.getElementById("doctorDetails");
    
    if (!doctorId || doctorId === 'None') {
        detailsDiv.innerHTML = "<em>You have not been assigned a doctor yet.</em>";
        return;
    }
    try {
        const res = await fetch(/api/doctor/${doctorId});
        const doctor = await res.json();
        if (res.ok) {
            detailsDiv.innerHTML = `
                <p>
                    <strong>Dr. ${doctor.name || 'Name not available'}</strong><br>
                    Email: ${doctor.email || 'N/A'}
                </p>
            `;
        } else {
            detailsDiv.innerHTML = <em>Error: Could not find doctor details.</em>;
        }
    } catch (err) {
        detailsDiv.innerHTML = <em>Failed to load doctor information.</em>;
    }
}

// --- Load Meal History ---
async function loadMealHistory() {
    const motherId = getMotherId();
    if (!motherId) return;

    try {
        const res = await fetch(/api/meals/mother/${motherId});
        const meals = await res.json();

        if (!Array.isArray(meals) || meals.length === 0) {
            document.getElementById("mealHistory").innerHTML = "<em>No meals yet.</em>";
            return;
        }

        let html = "";
        meals.forEach((m) => {
            const n = m.nutrients || {};
            const dish = m.dish_name || "Unknown Dish";
            const mealType = m.mealType ? m.mealType.charAt(0).toUpperCase() + m.mealType.slice(1) : "Meal";
            const mealDate = m.mealDate || "Date Unavailable";

            html += `
                <div class="meal-item">
                    <div>
                        <strong>${dish}</strong>
                        <span>${mealType} ‚Äî ${mealDate}</span>
                    </div>
                    <small style="color: #6c757d;">Status: ${m.status || "unknown"}</small>
                </div>
            `;
        });
        document.getElementById("mealHistory").innerHTML = html;

    } catch (err) {
        document.getElementById("mealHistory").innerHTML = "<em>Failed to load history.</em>";
    }
}

// Refresh button
document.getElementById("refreshHistory").addEventListener("click", () => {
    loadMealHistory();
});

// --- Handle Meal Upload (This is the critical part) ---
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    document.getElementById("resultArea").innerHTML = "<em><div style='color: #007bff;'>Uploading and Analyzing... please wait.</div></em>";

    try {
        const res = await fetch("/api/meals/upload", { method: "POST", body: fd });
        const data = await res.json(); // This is the response from upload_meal

        if (!res.ok) {
            document.getElementById("resultArea").innerHTML =
                `<strong style='color: red;'>Upload Error (${res.status})</strong>
                 <pre>` + JSON.stringify(data, null, 2) + "</pre>";
            return;
        }

        // 1. Show a simple success message in the "Upload Result"
        document.getElementById("resultArea").innerHTML = `
            <strong style="color: green;">‚úÖ Upload Successful!</strong>
            <p>Your meal <strong>${data.meal.dish_name}</strong> has been logged.</p>
        `;
        
        // --- THIS IS THE MAGIC ---
        // 2. Get the recommendation from the JSON response
        const recommendation = data.next_meal_recommendation;
        const recArea = document.getElementById("recommendation-area");
        let recHtml = "";

        if (recommendation) {
            // 3. Build the NEW HTML for the recommendation
            recHtml = `
                <div class="recommendation-box">
                    <p><strong>${recommendation.reason}</strong></p>
                    <h3>For your next meal, try: ${recommendation['Dish Name']}</h3>
                    <p>
                        We found a recipe for you:
                        <a href="${recommendation['recipe_link']}" target="_blank">
                            View Recipe
                        </a>
                    </p>
                </div>
            `;
        } else {
            // 3b. Build the HTML for "no recommendation"
            recHtml = "<p>You're doing great! No specific recommendations right now.</p>";
        }
        
        // 4. Instantly replace the old recommendation with the new one
        recArea.innerHTML = recHtml;
        // --- END OF MAGIC ---

        // 5. Refresh the meal history list
        loadMealHistory();

    } catch (err) {
        document.getElementById("resultArea").innerHTML =
            "<pre style='color: red;'>‚ùå Upload failed: " + err.message + "</pre>";
    }
});

// --- Initialize on page load ---
window.addEventListener("load", () => {
    loadMealHistory();
    loadDoctorDetails(); 
    // We removed loadAlerts() and loadRemainingNutrients()
});

</script>

<button class="floating-btn" id="openQueryBtn" title="Ask a Question">?</button>
<div id="queryModal" class="modal">
    </div>
<script>
    // ... (modal JavaScript) ...
</script>

{%¬†endblock¬†%}
{% extends "base.html" %}
{% block content %}

<style>
    /* All your CSS styles */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7fa;
        color: #333;
        line-height: 1.6;
    }
    .card {
        background-color: #ffffff;
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 24px;
        margin-bottom: 24px;
    }
    h2, h3 {
        color: #007bff;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
        margin-top: 0;
        margin-bottom: 16px;
    }
    label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-weight: 600;
        color: #555;
    }
    input:not([type="file"]), select, button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
    }
    button {
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        font-weight: bold;
    }
    button:hover { background-color: #0056b3; }
    #refreshHistory {
        background-color: #6c757d;
        margin-bottom: 16px;
    }
    #refreshHistory:hover { background-color: #5a6268; }
    
    /* NEW Recommendation Box Style */
    .recommendation-box {
        background: #f4f8ff; 
        border: 1px solid #c9dbff; 
        border-radius: 12px; 
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .recommendation-box h3 {
        color: #0056b3; /* Darker blue */
        border: none; /* No line */
    }
    .recommendation-box a {
        font-weight: bold;
        color: #007bff;
    }

    #resultArea, #mealHistory {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    .meal-item {
        border-bottom: 1px solid #e9ecef;
        padding: 12px 0;
    }
    .meal-item:last-child { border-bottom: none; }
    .meal-item strong { color: #007bff; font-size: 1.1em; }
    pre {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
    }
    /* ... (keep your floating button and modal styles) ... */
    .floating-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        border: none;
        font-size: 24px;
        z-index: 9999;
        cursor: pointer;
    }
    .modal { 
        display: none; 
        position: fixed; 
        z-index: 10000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5); 
        overflow-y: auto; /* Allow scrolling in modal background */
    }
    .modal-content { 
        background-color: #fff; 
        margin: 5% auto; 
        padding: 30px; 
        border-radius: 12px; 
        width: 90%; 
        max-width: 700px; 
        max-height: 85vh; /* Limit height to 85% of viewport */
        overflow-y: auto; /* Allow scrolling inside modal content */
    }
    .close-modal { 
        color: #aaa; 
        float: right; 
        font-size: 32px; 
        font-weight: bold; 
        cursor: pointer; 
    }
    .close-modal:hover {
        color: #000;
    }
    /* ... (keep query history styles) ... */
    .query-history-item { 
        background: #f8f9fa; 
        border-left: 4px solid #007bff; 
        padding: 12px; 
        margin-bottom: 12px; 
        border-radius: 6px; 
    }
    .query-answer { 
        background: #e6f7ff; 
        border-left: 4px solid #28a745; 
        padding: 12px; 
        margin-top: 8px; 
        border-radius: 4px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .query-answer p {
        font-size: 1em;
        line-height: 1.5;
        margin: 6px 0 0 0;
    }
    #queryModal textarea { 
        width: 100%; 
        min-height: 100px; 
        padding: 10px; 
        border: 1px solid #ced4da; 
        border-radius: 6px; 
        resize: vertical;
        font-family: inherit;
    }
</style>

<h2>Your Daily Recommendation</h2>

<div id="recommendation-area">
    {% if latest_recommendation %}
        <div class="recommendation-box">
            <p><strong>{{ latest_recommendation.reason }}</strong></p>
            <h3>For your next meal, try: {{ latest_recommendation['Dish Name'] }}</h3>
            <p>
                We found a recipe for you:
                <a href="{{ latest_recommendation['recipe_link'] }}" target="_blank">
                    View Recipe
                </a>
            </p>
        </div>
    {% else %}
        <p>You're doing great! No specific recommendations right now. Keep logging your meals!</p>
    {% endif %}
</div>

---

<div class="card" style="background-color: #e9f5ff;">
    <h3>Assigned Doctor</h3>
    <div id="doctorDetails"><em>Checking assignment...</em></div>
</div>
<input type="hidden" id="assignedDoctorId" value="{{ assigned_doctor_id }}" />

---

<div class="card">
    <h2>Upload Meal Photo</h2>
    <p>Upload your meal photo, select the meal type and date. The system will analyze your meal and update your recommendation.</p>

    <form id="uploadForm">
        <input type="hidden" id="motherId" name="motherId" value="{{ mother_id }}" />
        <label for="mealType">Meal Type</label>
        <select id="mealType" name="mealType" required>
            <option value="">-- Select Meal --</option>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
        </select>
        <label for="mealDate">Meal Date</label>
        <input id="mealDate" name="mealDate" type="date" required />
        <label for="image">Meal Image</label>
        <input id="image" name="image" type="file" accept="image/*" required style="padding: 6px;"/> 
        <button type="submit" style="margin-top:16px;">üì∏ Upload & Analyze Meal</button>
    </form>
</div>

---

<div class="card">
    <h3>Upload Result</h3>
    <div id="resultArea"><em>No upload yet.</em></div>
</div>

---

<div class="card">
    <h3>Your Meal History</h3>
    <button id="refreshHistory">üîÑ Refresh History</button>
    <div id="mealHistory"><em>Loading...</em></div>
</div>


<script>
function getMotherId() {
    return document.getElementById("motherId").value.trim();
}

// --- Load Doctor Details ---
async function loadDoctorDetails() {
    const doctorId = document.getElementById("assignedDoctorId").value.trim();
    const detailsDiv = document.getElementById("doctorDetails");
    
    if (!doctorId || doctorId === 'None') {
        detailsDiv.innerHTML = "<em>You have not been assigned a doctor yet.</em>";
        return;
    }
    try {
        const res = await fetch(`/api/doctor/${doctorId}`);
        const doctor = await res.json();
        if (res.ok) {
            detailsDiv.innerHTML = `
                <p>
                    <strong>Dr. ${doctor.name || 'Name not available'}</strong><br>
                    Email: ${doctor.email || 'N/A'}
                </p>
            `;
        } else {
            detailsDiv.innerHTML = `<em>Error: Could not find doctor details.</em>`;
        }
    } catch (err) {
        detailsDiv.innerHTML = `<em>Failed to load doctor information.</em>`;
    }
}

// --- Load Meal History ---
async function loadMealHistory() {
    const motherId = getMotherId();
    if (!motherId) return;

    try {
        const res = await fetch(`/api/meals/mother/${motherId}`);
        const meals = await res.json();

        if (!Array.isArray(meals) || meals.length === 0) {
            document.getElementById("mealHistory").innerHTML = "<em>No meals yet.</em>";
            return;
        }

        let html = "";
        meals.forEach((m) => {
            const n = m.nutrients || {};
            const dish = m.dish_name || "Unknown Dish";
            const mealType = m.mealType ? m.mealType.charAt(0).toUpperCase() + m.mealType.slice(1) : "Meal";
            const mealDate = m.mealDate || "Date Unavailable";

            html += `
                <div class="meal-item">
                    <div>
                        <strong>${dish}</strong>
                        <span>${mealType} ‚Äî ${mealDate}</span>
                    </div>
                    <small style="color: #6c757d;">Status: ${m.status || "unknown"}</small>
                </div>
            `;
        });
        document.getElementById("mealHistory").innerHTML = html;

    } catch (err) {
        document.getElementById("mealHistory").innerHTML = "<em>Failed to load history.</em>";
    }
}

// Refresh button
document.getElementById("refreshHistory").addEventListener("click", () => {
    loadMealHistory();
});

// --- Handle Meal Upload (This is the critical part) ---
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    document.getElementById("resultArea").innerHTML = "<em><div style='color: #007bff;'>Uploading and Analyzing... please wait.</div></em>";

    try {
        const res = await fetch("/api/meals/upload", { method: "POST", body: fd });
        const data = await res.json(); // This is the response from upload_meal

        if (!res.ok) {
            document.getElementById("resultArea").innerHTML =
                `<strong style='color: red;'>Upload Error (${res.status})</strong>
                 <pre>` + JSON.stringify(data, null, 2) + "</pre>";
            return;
        }

        // 1. Show a simple success message in the "Upload Result"
        document.getElementById("resultArea").innerHTML = `
            <strong style="color: green;">‚úÖ Upload Successful!</strong>
            <p>Your meal <strong>${data.meal.dish_name}</strong> has been logged.</p>
        `;
        
        // --- THIS IS THE MAGIC ---
        // 2. Get the recommendation from the JSON response
        const recommendation = data.next_meal_recommendation;
        const recArea = document.getElementById("recommendation-area");
        let recHtml = "";

        if (recommendation) {
            // 3. Build the NEW HTML for the recommendation
            recHtml = `
                <div class="recommendation-box">
                    <p><strong>${recommendation.reason}</strong></p>
                    <h3>For your next meal, try: ${recommendation['Dish Name']}</h3>
                    <p>
                        We found a recipe for you:
                        <a href="${recommendation['recipe_link']}" target="_blank">
                            View Recipe
                        </a>
                    </p>
                </div>
            `;
        } else {
            // 3b. Build the HTML for "no recommendation"
            recHtml = "<p>You're doing great! No specific recommendations right now.</p>";
        }
        
        // 4. Instantly replace the old recommendation with the new one
        recArea.innerHTML = recHtml;
        // --- END OF MAGIC ---

        // 5. Refresh the meal history list
        loadMealHistory();

    } catch (err) {
        document.getElementById("resultArea").innerHTML =
            "<pre style='color: red;'>‚ùå Upload failed: " + err.message + "</pre>";
    }
});

// --- Initialize on page load ---
window.addEventListener("load", () => {
    loadMealHistory();
    loadDoctorDetails(); 
    // We removed loadAlerts() and loadRemainingNutrients()
});

</script>

<button class="floating-btn" id="openQueryBtn" title="Ask a Question">?</button>

<!-- Query Modal -->
<div id="queryModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeModal">&times;</span>
        <h2 style="margin-top: 0; color: #007bff;">üì© Ask a Question</h2>
        
        <form id="queryForm">
            <label for="querySubject" style="font-weight: 600; margin-bottom: 4px;">Subject</label>
            <input type="text" id="querySubject" name="subject" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; margin-bottom: 12px;" />
            
            <label for="queryMessage" style="font-weight: 600; margin-bottom: 4px;">Your Question</label>
            <textarea id="queryMessage" name="message" required></textarea>
            
            <button type="submit" style="background: #007bff; color: #fff; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold;">Send Query</button>
        </form>

        <div id="querySuccess" style="display: none; background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-top: 16px;">
            ‚úÖ Your query has been sent successfully!
        </div>

        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e9ecef;" />

        <h3 style="color: #007bff;">üìã Your Past Queries</h3>
        <div id="queryHistoryArea"><em style="color: #6c757d;">Loading...</em></div>
    </div>
</div>

<script>
// Query Modal functionality
const modal = document.getElementById("queryModal");
const openBtn = document.getElementById("openQueryBtn");
const closeBtn = document.getElementById("closeModal");

openBtn.onclick = function() {
    modal.style.display = "block";
    loadQueryHistory();
}

closeBtn.onclick = function() {
    modal.style.display = "none";
    document.getElementById("querySuccess").style.display = "none";
    document.getElementById("queryForm").reset();
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
        document.getElementById("querySuccess").style.display = "none";
        document.getElementById("queryForm").reset();
    }
}

// Submit query
document.getElementById("queryForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const subject = document.getElementById("querySubject").value;
    const message = document.getElementById("queryMessage").value;

    try {
        const res = await fetch("/api/queries/create", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                subject: subject,
                message: message,
                category: "general"
            })
        });

        const data = await res.json();
        
        if (data.success) {
            document.getElementById("querySuccess").style.display = "block";
            document.getElementById("queryForm").reset();
            loadQueryHistory();
            setTimeout(() => {
                document.getElementById("querySuccess").style.display = "none";
            }, 3000);
        } else {
            alert("Failed to send query: " + (data.error || "Unknown error"));
        }
    } catch (err) {
        alert("Failed to send query. Please try again. Error: " + err.message);
    }
});

// Load query history for this mother
async function loadQueryHistory() {
    try {
        const res = await fetch("/api/queries/my-queries", {
            credentials: 'include'
        });
        const data = await res.json();

        if (!data.success || !Array.isArray(data.queries) || data.queries.length === 0) {
            document.getElementById("queryHistoryArea").innerHTML = "<em style='color: #6c757d;'>No queries yet.</em>";
            return;
        }

        let html = "";
        data.queries.forEach(q => {
            const date = new Date(q.createdAt).toLocaleString();
            
            // Determine status badge color
            let statusColor = '#6c757d'; // default gray
            if (q.status === 'resolved' || q.status === 'answered') statusColor = '#28a745'; // green
            else if (q.status === 'in-progress') statusColor = '#007bff'; // blue
            else if (q.status === 'pending') statusColor = '#ffc107'; // yellow
            
            html += `
                <div class="query-history-item">
                    <strong style="color: #007bff;">${q.subject}</strong>
                    <p style="margin: 8px 0; color: #333;">${q.message}</p>
                    <small style="color: #6c757d;">
                        ${date} ‚Ä¢ Status: 
                        <strong style="color: ${statusColor}; text-transform: uppercase;">
                            ${q.status}
                        </strong>
                    </small>
            `;
            
            // Show all replies if they exist
            if (q.replies && q.replies.length > 0) {
                html += `<div style="margin-top: 12px;">`;
                q.replies.forEach(reply => {
                    const replyDate = new Date(reply.repliedAt).toLocaleString();
                    html += `
                        <div class="query-answer">
                            <strong style="color: #28a745;">‚úì ${reply.doctorName} replied:</strong>
                            <p style="margin: 6px 0 0 0; color: #333;">${reply.message}</p>
                            <small style="color: #6c757d;">${replyDate}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (q.response) {
                // Handle old-style query format with single 'response' field
                const replyDate = q.respondedAt ? new Date(q.respondedAt).toLocaleString() : 'Date unavailable';
                html += `
                    <div style="margin-top: 12px;">
                        <div class="query-answer">
                            <strong style="color: #28a745;">‚úì Doctor replied:</strong>
                            <p style="margin: 6px 0 0 0; color: #333;">${q.response}</p>
                            <small style="color: #6c757d;">${replyDate}</small>
                        </div>
                    </div>
                `;
            } else if (q.status === 'pending') {
                html += `
                    <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px;">
                        <small style="color: #856404;">‚è≥ Waiting for doctor's response...</small>
                    </div>
                `;
            }
            
            html += `</div>`;
        });

        document.getElementById("queryHistoryArea").innerHTML = html;
    } catch (err) {
        console.error("Query history error:", err);
        document.getElementById("queryHistoryArea").innerHTML = "<em style='color: #dc3545;'>Failed to load query history.</em>";
    }
}
</script>

{% endblock %}
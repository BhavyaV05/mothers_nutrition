{% extends "base.html" %}
{% block content %}

<style>
    /* General body/container style */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7fa; /* Light background */
        color: #333;
        line-height: 1.6;
    }

    /* Card styling for sections */
    .card {
        background-color: #ffffff;
        border: none;
        border-radius: 12px; /* Smoother corners */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Subtle shadow */
        padding: 24px;
        margin-bottom: 24px;
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-2px); /* Slight lift on hover */
    }

    /* Headings */
    h2, h3 {
        color: #007bff; /* Primary blue color */
        border-bottom: 2px solid #e9ecef; /* Light separator */
        padding-bottom: 8px;
        margin-top: 0;
        margin-bottom: 16px;
    }

    /* Form labels and inputs */
    label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-weight: 600; /* Bolder labels */
        color: #555;
    }

    input:not([type="file"]), select, button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-sizing: border-box; /* Include padding in width */
        font-size: 16px;
        transition: border-color 0.2s;
    }

    input:focus, select:focus {
        border-color: #007bff; /* Highlight on focus */
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }

    /* Button styling */
    button {
        cursor: pointer;
        background-color: #007bff; /* Primary action color */
        color: white;
        border: none;
        font-weight: bold;
        transition: background-color 0.2s;
    }

    button:hover {
        background-color: #0056b3;
    }

    /* Secondary button for Refresh History */
    #refreshHistory {
        background-color: #6c757d; /* Muted gray/secondary color */
        margin-bottom: 16px;
    }

    #refreshHistory:hover {
        background-color: #5a6268;
    }

    /* Alert Box Styling (Redesigned) */
    #alertBox {
        background: #fff0f0; /* Very light red background */
        border: 2px solid #ff4d4d; /* Stronger red border */
        color: #cc0000; /* Darker red text */
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        font-size: 1.1em;
        display: flex !important; /* Use flex for better alignment */
        align-items: flex-start;
    }

    #alertBox strong {
        font-size: 1.2em;
        margin-right: 10px;
        color: #cc0000; /* Ensure icon/title is visible */
    }

    #alertText {
        margin-top: 0;
        flex-grow: 1; /* Allows text to take up space */
    }

    /* Upload Result Styling */
    #resultArea, #mealHistory {
        background-color: #f8f9fa; /* Light gray background for content areas */
        padding: 15px;
        border-radius: 8px;
        border: 1px dashed #e9ecef;
    }

    /* Meal History Item Styling */
    .meal-item {
        border-bottom: 1px solid #e9ecef;
        padding: 12px 0;
    }

    .meal-item:last-child {
        border-bottom: none; /* No border for the last item */
    }

    .meal-item strong {
        color: #007bff;
        font-size: 1.1em;
    }

    /* Preformatted text inside results */
    pre {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.9em;
    }

    /* Floating query button */
    .floating-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        border: none;
        font-size: 24px;
        z-index: 9999;
        cursor: pointer;
    }

    .floating-btn:hover {
        transform: translateY(-3px);
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
    }

    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        max-height: 80vh;
        overflow-y: auto;
    }

    .close-modal {
        color: #aaa;
        float: right;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

    .close-modal:hover {
        color: #000;
    }

    .query-history-item {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 6px;
    }

    .query-answer {
        background: #e6f7ff;
        border-left: 4px solid #28a745;
        padding: 10px;
        margin-top: 8px;
        border-radius: 4px;
    }

    #queryModal textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        resize: vertical;
        font-family: inherit;
    }

    #queryModal button {
        margin-top: 10px;
    }
</style>

<div id="alertBox"
     style="display:none;">
    <strong>‚ö†Ô∏è Nutrient Alert:</strong>
    <div id="alertText"></div>
</div>


<div class="card">
    <h3>Remaining Nutrients for Today</h3>
    <div id="remainingNutrients"><em>Loading...</em></div>
</div>
<div class="card" style="background-color: #e9f5ff;">
    <h3>Assigned Doctor</h3>
    <div id="doctorDetails"><em>Checking assignment...</em></div>
</div>

<input type="hidden" id="assignedDoctorId" value="{{ assigned_doctor_id }}" />


<div class="card">
    <h2>Upload Meal Photo</h2>
    <p>Upload your meal photo, select the meal type and date. The system will analyze your meal and compare it with your doctor's plan.</p>

    <form id="uploadForm">
        <input type="hidden" id="motherId" name="motherId" value="{{ mother_id }}" />

        <label for="mealType">Meal Type</label>
        <select id="mealType" name="mealType" required>
            <option value="">-- Select Meal --</option>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
        </select>

        <label for="mealDate">Meal Date</label>
        <input id="mealDate" name="mealDate" type="date" required />

        <label for="image">Meal Image</label>
        <input id="image" name="image" type="file" accept="image/*" required style="padding: 6px;"/> 

        <button type="submit" style="margin-top:16px;">üì∏ Upload & Analyze Meal</button>
    </form>
</div>

---

<div class="card">
    <h3>Upload Result</h3>
    <div id="resultArea"><em>No upload yet.</em></div>
</div>

---

<div class="card">
    <h3>Your Meal History</h3>
    <button id="refreshHistory">üîÑ Refresh History</button>
    <div id="mealHistory"><em>Loading...</em></div>
</div>

<script>
// ---------- Load Meal History (Modified to use new CSS class) ----------
// ---------- Load Remaining Nutrients ----------
function getMotherId() {
    // This will securely get the ID from the hidden input field
    return document.getElementById("motherId").value.trim();
}
// Function to display doctor details
async function loadDoctorDetails() {
    const doctorId = document.getElementById("assignedDoctorId").value.trim();
    const detailsDiv = document.getElementById("doctorDetails");
    
    if (!doctorId || doctorId === 'None') {
        detailsDiv.innerHTML = "<em>You have not been assigned a doctor yet.</em>";
        return;
    }

    try {
        const res = await fetch(`/api/doctor/${doctorId}`);
        const doctor = await res.json();

        if (res.ok) {
            detailsDiv.innerHTML = `
                <p>
                    <strong>Dr. ${doctor.name || 'Name not available'}</strong><br>
                    Email: ${doctor.email || 'N/A'}<br>
                    <small style="color: #6c757d;">(ID: ${doctorId})</small>
                </p>
            `;
        } else {
            detailsDiv.innerHTML = `<em>Error: Could not find doctor details.</em>`;
        }
    } catch (err) {
        detailsDiv.innerHTML = `<em>Failed to load doctor information.</em>`;
    }
}

// Add the call to the window load listener:
window.addEventListener("load", () => {
    loadMealHistory();
    loadAlerts();
    loadRemainingNutrients();
    loadDoctorDetails(); // <-- NEW CALL
});
async function loadRemainingNutrients() {
    const motherId = getMotherId(); // Use the secure function
    if (!motherId) return;

    try {
        const res = await fetch(`/api/nutrients/remaining/${motherId}`);
        const data = await res.json();

        if (!data || !data.remaining) {
            document.getElementById("remainingNutrients").innerHTML = "<em>No data available.</em>";
            return;
        }

        const r = data.remaining;
        const c = data.consumed;
        const req = data.required;
        
        // Define the nutrients to display and their units
        const nutrientList = [
            { key: "kcal", label: "Energy (kcal)", unit: "kcal" },
            { key: "protein", label: "Protein (g)", unit: "g" },
            { key: "carbs", label: "Carbs (g)", unit: "g" },
            { key: "fat", label: "Fat (g)", unit: "g" }
        ];

        document.getElementById("remainingNutrients").innerHTML = `
            <table style="width:100%; border-collapse: collapse;">
                <tr style="background-color:#f8f9fa;">
                    <th style="text-align:left; padding:8px;">Nutrient</th>
                    <th style="text-align:right; padding:8px;">Consumed</th>
                    <th style="text-align:right; padding:8px;">Required</th>
                    <th style="text-align:right; padding:8px;">Remaining</th>
                </tr>
                ${nutrientList.map(n => `
                    <tr>
                        <td style="padding:8px;">${n.label}</td>
                        <td style="text-align:right; padding:8px;">${c[n.key] || 0} ${n.unit}</td>
                        <td style="text-align:right; padding:8px;">${req[n.key] || 0} ${n.unit}</td>
                        <td style="text-align:right; padding:8px; color:${r[n.key] <= 0 ? 'green' : 'red'}; font-weight: bold;">
                            ${r[n.key] > 0 ? r[n.key] : 0} ${n.unit}
                        </td>
                    </tr>
                `).join("")}
            </table>
        `;
    } catch (err) {
        document.getElementById("remainingNutrients").innerHTML = "<em>Failed to load nutrition plan or totals.</em>";
    }
}

async function loadMealHistory() {
    const motherId = getMotherId(); // Use the secure function
    if (!motherId) return;

    try {
        const res = await fetch(`/api/meals/mother/${motherId}`);
        const meals = await res.json();

        if (!Array.isArray(meals) || meals.length === 0) {
            document.getElementById("mealHistory").innerHTML = "<em>No meals yet.</em>";
            return;
        }

        let html = "";
        meals.forEach((m) => {
            const n = m.nutrients || {};
            const dish = m.dish_name || "Unknown Dish";
            const mealType = m.mealType ? m.mealType.charAt(0).toUpperCase() + m.mealType.slice(1) : "Meal";
            const mealDate = m.mealDate || "Date Unavailable";

            html += `
                <div class="meal-item">
                    <div class="meal-header">
                        <strong>${dish}</strong>
                        <span>${mealType} ‚Äî ${mealDate}</span>
                    </div>

                    <table class="nutrient-table" style="font-size: 0.9em; width: 100%; margin-top: 5px;">
                        <tr><th>Nutrient</th><th>Amount</th></tr>
                        <tr><td>Energy</td><td>${n.kcal || 0} kcal</td></tr>
                        <tr><td>Carbohydrates</td><td>${n.carb_g || 0} g</td></tr>
                        <tr><td>Protein</td><td>${n.protein_g || 0} g</td></tr>
                        <tr><td>Fat</td><td>${n.fat_g || 0} g</td></tr>
                        <tr><td>Free Sugar</td><td>${n.free_sugar_g || 0} g</td></tr>
                        <tr><td>Fibre</td><td>${n.fibre_g || 0} g</td></tr>
                        <tr><td>Sodium</td><td>${n.sodium_mg || 0} mg</td></tr>
                        <tr><td>Calcium</td><td>${n.calcium_mg || 0} mg</td></tr>
                        <tr><td>Iron</td><td>${n.iron_mg || 0} mg</td></tr>
                        <tr><td>Vitamin C</td><td>${n.vitamin_c_mg || 0} mg</td></tr>
                        <tr><td>Folate</td><td>${n.folate_ug || 0} ¬µg</td></tr>
                    </table>

                    <small class="meal-status" style="float: right; color: #6c757d;">Status: ${m.status || "unknown"}</small>
                </div>
            `;
        });

        document.getElementById("mealHistory").innerHTML = html;

    } catch (err) {
        document.getElementById("mealHistory").innerHTML = "<em>Failed to load history.</em>";
    }
}

// Refresh button
document.getElementById("refreshHistory").addEventListener("click", () => {
    loadMealHistory();
    loadRemainingNutrients();
});



// ---------- Load Nutrient Alerts (Unchanged logic) ----------
async function loadAlerts() {
    const motherId = getMotherId(); // Use the secure function
    if (!motherId) return;
    try {
        const res = await fetch(`/api/alerts/${motherId}`);
        const alerts = await res.json();
        if (!alerts || alerts.length === 0) {
            document.getElementById("alertBox").style.display = "none";
            return;
        }
        const latest = alerts[0];
        const deficits = latest.nutrient_deficit || {};
        const lines = Object.entries(deficits).map(
            ([k, v]) => `<li style="margin-left: 15px;">**${k.toUpperCase()}**: ${v.actual}/${v.required} (${v.percent}%)</li>`
        );
        document.getElementById("alertText").innerHTML = `
            Low intake detected on **${latest.mealDate}** (Deficit vs. Required):<br/>
            <ul style="padding-left: 0; list-style-type: none;">${lines.join("")}</ul>
        `;
        document.getElementById("alertBox").style.display = "flex";
    } catch (err) {
        // Silently fail if alerts can't load
        document.getElementById("alertBox").style.display = "none";
    }
}

// ---------- Handle Meal Upload (Unchanged logic) ----------
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    document.getElementById("resultArea").innerHTML = "<em><div style='color: #007bff;'>Uploading and Analyzing... please wait.</div></em>";

    try {
        const res = await fetch("/api/meals/upload", { method: "POST", body: fd });
        const data = await res.json();

        if (!res.ok) {
            document.getElementById("resultArea").innerHTML =
                `<strong style='color: red;'>Upload Error (${res.status})</strong>
                 <pre>` + JSON.stringify(data, null, 2) + "</pre>";
            return;
        }

        // Display upload + OCR + nutrient check results
        let html = `
            <strong style="color: green;">‚úÖ Upload Successful!</strong>
            <br/>
            <strong>Meal created:</strong>
            <pre>${JSON.stringify(data.meal, null, 2)}</pre>
            <strong>OCR Result:</strong>
            <pre>${JSON.stringify(data.ocr_result, null, 2)}</pre>
        `;
        if (data.meal_check && data.meal_check.alert_created) {
            html += `<strong style="color:#cc0000; display: block; margin-top: 10px;">‚ö†Ô∏è Nutrient Deficit Detected!</strong>
                     <pre>${JSON.stringify(data.meal_check.deficits, null, 2)}</pre>`;
        }
        document.getElementById("resultArea").innerHTML = html;

        // Refresh UI
        loadMealHistory();
        loadAlerts();
        loadRemainingNutrients(); // Refresh remaining nutrients after a meal upload

    } catch (err) {
        document.getElementById("resultArea").innerHTML =
            "<pre style='color: red;'>‚ùå Upload failed: " + err.message + "</pre>";
    }
});

// ---------- Initialize on load ----------
window.addEventListener("load", () => {
    // Ensure data loads immediately for the logged-in user
    loadMealHistory();
    loadAlerts();
    loadRemainingNutrients();
});
</script>

<!-- Floating Query Button: opens modal -->
<button class="floating-btn" id="openQueryBtn" title="Ask a Question">?</button>

<!-- Query Modal -->
<div id="queryModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeModal">&times;</span>
        <h2 style="margin-top: 0; color: #007bff;">üì© Ask a Question</h2>
        
        <form id="queryForm">
            <label for="querySubject" style="font-weight: 600; margin-bottom: 4px;">Subject</label>
            <input type="text" id="querySubject" name="subject" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; margin-bottom: 12px;" />
            
            <label for="queryMessage" style="font-weight: 600; margin-bottom: 4px;">Your Question</label>
            <textarea id="queryMessage" name="message" required></textarea>
            
            <button type="submit" style="background: #007bff; color: #fff; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold;">Send Query</button>
        </form>

        <div id="querySuccess" style="display: none; background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-top: 16px;">
            ‚úÖ Your query has been sent successfully!
        </div>

        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e9ecef;" />

        <h3 style="color: #007bff;">üìã Your Past Queries</h3>
        <div id="queryHistoryArea"><em style="color: #6c757d;">Loading...</em></div>
    </div>
</div>

<script>
// Query Modal functionality
const modal = document.getElementById("queryModal");
const openBtn = document.getElementById("openQueryBtn");
const closeBtn = document.getElementById("closeModal");

openBtn.onclick = function() {
    modal.style.display = "block";
    loadQueryHistory();
}

closeBtn.onclick = function() {
    modal.style.display = "none";
    document.getElementById("querySuccess").style.display = "none";
    document.getElementById("queryForm").reset();
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
        document.getElementById("querySuccess").style.display = "none";
        document.getElementById("queryForm").reset();
    }
}

// Submit query
document.getElementById("queryForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const motherId = getMotherId();
    const subject = document.getElementById("querySubject").value;
    const message = document.getElementById("queryMessage").value;

    const formData = new FormData();
    formData.append("motherId", motherId);
    formData.append("subject", subject);
    formData.append("message", message);

    try {
        const res = await fetch("/query", {
            method: "POST",
            body: formData
        });

        if (res.ok) {
            document.getElementById("querySuccess").style.display = "block";
            document.getElementById("queryForm").reset();
            loadQueryHistory();
            setTimeout(() => {
                document.getElementById("querySuccess").style.display = "none";
            }, 3000);
        }
    } catch (err) {
        alert("Failed to send query. Please try again.");
    }
});

// Load query history for this mother
async function loadQueryHistory() {
    const motherId = getMotherId();
    if (!motherId) return;

    try {
        const res = await fetch(`/api/queries/mother/${motherId}`);
        const queries = await res.json();

        if (!Array.isArray(queries) || queries.length === 0) {
            document.getElementById("queryHistoryArea").innerHTML = "<em style='color: #6c757d;'>No queries yet.</em>";
            return;
        }

        let html = "";
        queries.forEach(q => {
            const date = new Date(q.createdAt).toLocaleString();
            html += `
                <div class="query-history-item">
                    <strong style="color: #007bff;">${q.subject}</strong>
                    <p style="margin: 8px 0; color: #333;">${q.message}</p>
                    <small style="color: #6c757d;">${date} ‚Ä¢ Status: <strong>${q.status}</strong></small>
            `;
            
            if (q.response) {
                html += `
                    <div class="query-answer">
                        <strong style="color: #28a745;">‚úì Doctor's Response:</strong>
                        <p style="margin: 6px 0 0 0; color: #333;">${q.response}</p>
                    </div>
                `;
            }
            
            html += `</div>`;
        });

        document.getElementById("queryHistoryArea").innerHTML = html;
    } catch (err) {
        document.getElementById("queryHistoryArea").innerHTML = "<em style='color: #dc3545;'>Failed to load query history.</em>";
    }
}
</script>

{% endblock %}